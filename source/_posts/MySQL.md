---
title: MySQL
date: 2018-11-16 21:55:11
updated: 2019-08-12 12:00:00
tags: [Database]
typora-root-url: ../
---

The world's most popular open source database

<!-- more -->

# 一、数据库范式

数据库范式是为了数据库设计的规范化而提出的一些概念。从第一范式到第六范式要求越严格，约束性越高。通俗来讲，即范式越小，数据冗余越大（数据重复），表现为存储变大，且对更新数据不友好；而范式越大，查询需要跨表。最好的实践是，需要根据业务设计合理的数据库Schema，通常围绕在第三范式。

## 1.1 第三范式

关系模式中不允许有传递依赖。直观上判断，就是其它字段值只受限于主键。实践中，需要根据具体读写场景设计数据冗余度。

# 二、MySQL索引

## 2.1 索引原理

- InnoDB与MyISAM索引区别

  ![](/images/mysql1.png)

现在MySQL默认使用InnoDB，而MyISAM不支持事务，正常情况不会使用。因此后面内容只针对InnoDB。

InnoDB中有BTREE（实际上是B+树，叶子结点存数据），HASH与FULLTEXT。

在InnoDB中，哈希索引是自适应的，用户不可干预。

## 2.2 聚簇索引

是依照主键来构建的。主键会默认构建索引。

在用普通索引检索时，会先根据该key找到主键，再通过主键找到记录，因此有两步操作。

# 三、MySQL并发

锁是加在索引上的。比如对记录进行更新，会先锁住主键索引，如果更新的是索引字段，又会再锁住该索引。另一种情况，如果更新时是根据普通索引字段检索，会先锁住该索引，再锁住主键索引。

InnoDB在RR隔离下不会出现幻读，因为使用了Next-key Lock。

## 3.1 MVCC（Multi-Version Concurrency Control）

无锁方案实现的读写并发控制。

读操作分为当前读与快照读。

快照读可以防止幻读、不可重复读。

通过对记录添加两个隐藏列实现，一个是db_trx_id指向修改该记录的事务id，另一个是db_roll_ptr指向undo log中的未提交事务链表，可以找到修改的历史版本。

一致性读指一个事务根据快照来返回结果。比如一个数据在查询时被其他事务修改了，仍然会通过undo log来找回原来的数据生成读的结果。

MVCC可作用在RR、RC隔离下。

## 3.2 2PL（Two-Phase Locking）

在对数据进行读写操作的时候，首先获取数据的锁。

事务会一次性释放所有锁，并且不再获取其他锁。

事务会分成两个阶段：加锁与解锁，并且两个阶段不相交。

如果将两阶段锁实现成一次性获取所有锁，就不会存在死锁了。

## 3.3 死锁

InnoDB采用了上述两种方式实现读与写、写与写间的并发。因为仍然会采用悲观锁的机制，且并没有在事务中一次性获取所有锁，所以存在死锁风险。

## 3.4 RC、RR

两个隔离方式都有较多使用场景。在RC下，不存在Gap锁，并发高、死锁少，但是在当前读时，会存在不可重复读与幻读的问题。RR当前读时，会采用Next-Key Lock来避免幻读。

官方解读：**如果需要尽可能地减少死锁发生，可以采用RC隔离。**

## 3.5 常见的锁

### 3.5.1 行锁

#### Gap Lock

间隙锁不可作用于RC隔离下

#### Next-Key Lock可以防止幻读

检索唯一索引不存在的值时，也会产生Gap锁。如存在唯一值，则降级为Record Lock

非唯一索引非范围检索时也加Gap锁，是因为索引值是跟主键值一起存放的，锁是加在索引节点上的

#### Record Lock

### 3.5.2 其他锁

##### 共享锁（S）、排它锁（X）

##### 意向锁

##### 隐式锁

在只有一个事务操作数据行时，不需要加锁，只需要在隐藏列中标记一下即可

## 3.6 加锁过程示例

普通的select采用的是快照读，不加锁

select … lock in share mode  加共享锁

select … for update 加排它锁

### 3.6.1 复杂查询的加锁过程比较复杂，列出一些查看事务运行情况的命令

`show engine innodb status\G`

`show processlist`

`SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS`

`SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS`

`show open tables`